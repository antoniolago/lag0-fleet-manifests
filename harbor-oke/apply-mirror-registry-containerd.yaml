apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: apply-mirror-registry-crio
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: apply-mirror-registry-crio
  template:
    metadata:
      labels:
        name: apply-mirror-registry-crio
    spec:
      containers:
      - name: config-modifier
        image: busybox
        command:
          - sh
          - -c
          - |
            echo "Backing up existing CRI-O configuration..."
            if ! cp /host/etc/crio/crio.conf /host/etc/crio/crio.conf.bak; then
              echo "Backup failed, proceeding."
            fi
            echo "Updating CRI-O configuration..."
            sed -i 's#registries =.*#registries = ["harbor.lag0.com.br"]#' /host/etc/crio/crio.conf
            echo "Stopping CRI-O..."
            if ! kill $(pidof crio); then
              echo "Failed to stop CRI-O."
            fi
            echo "Starting CRI-O..."
            if /usr/bin/crio &; then
              echo "Started CRI-O successfully."
            else
              echo "Failed to start CRI-O. Manual intervention may be needed."
            fi
        securityContext:
          privileged: true
        volumeMounts:
        - mountPath: /host/etc/crio
          name: crio-config
          readOnly: false
      volumes:
      - name: crio-config
        hostPath:
          path: /etc/crio
          type: Directory
